<script>
window.onload = () => {
  const video = document.getElementById("camera");
  const canvas = document.getElementById("overlay");
  const captureBtn = document.getElementById("captureBtn");
  const uploadBtn = document.getElementById("uploadBtn");
  const historyBtn = document.getElementById("historyBtn");
  const patientInput = document.getElementById("patientId");
  const result = document.getElementById("result");
  let snapshotBlob = null;

  // âœ… å•Ÿå‹•ç›¸æ©Ÿï¼ˆç§»é™¤ exact æå‡ç›¸å®¹æ€§ï¼‰
  navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
    .then(stream => { video.srcObject = stream; })
    .catch(err => { alert("âŒ é¡é ­å•Ÿå‹•å¤±æ•—ï¼š" + err.message); });

  function onOpenCvReady() { requestAnimationFrame(drawOverlay); }

  function drawOverlay() {
    if (typeof cv === 'undefined' || video.videoWidth === 0) {
      return requestAnimationFrame(drawOverlay);
    }

    const tmp = document.createElement('canvas');
    tmp.width = video.videoWidth; tmp.height = video.videoHeight;
    tmp.getContext('2d').drawImage(video, 0, 0);

    let src = cv.imread(tmp);
    let hsv = new cv.Mat(); cv.cvtColor(src, hsv, cv.COLOR_RGB2HSV);

    // ğŸ¯ èª¿æ•´ HSV ç¯„åœç‚ºç²‰ç´…èˆŒè‰²
    let low = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [160, 30, 80, 0]);
    let high= new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [180, 150, 255, 255]);

    let mask = new cv.Mat(); cv.inRange(hsv, low, high, mask);
    let M = cv.Mat.ones(5,5,cv.CV_8U); cv.morphologyEx(mask, mask, cv.MORPH_OPEN, M);
    let contours = new cv.MatVector(), hier = new cv.Mat();
    cv.findContours(mask, contours, hier, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

    let cnt = null;
    if (contours.size() > 0) {
      let maxIdx = 0, maxA = 0;
      for (let i = 0; i < contours.size(); i++) {
        let a = cv.contourArea(contours.get(i));
        if (a > maxA) { maxA = a; maxIdx = i; }
      }
      // âœ… åŠ å…¥é¢ç©é–€æª»ï¼ˆç•«é¢ 5%ï¼‰
      if (maxA > video.videoWidth * video.videoHeight * 0.05) {
        cnt = contours.get(maxIdx);
      }
    }

    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height);

    if (cnt) {
      let approx = new cv.Mat(); cv.approxPolyDP(cnt, approx, 3, true);
      ctx.strokeStyle = '#ff69b4'; ctx.lineWidth = 4;
      ctx.beginPath();
      for (let i = 0; i < approx.rows; i++) {
        const x = approx.intAt(i,0), y = approx.intAt(i,1);
        i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
      }
      ctx.closePath(); ctx.stroke(); approx.delete();

      const r = cv.boundingRect(cnt);
      const [zx, zy, zw, zh] = [r.x, r.y, r.width, r.height];
      const zones = {
        'èˆŒå°–ï¼ˆå¿ƒè‚ºï¼‰': [[0.35,0.75],[0.65,0.75],[0.55,0.95],[0.45,0.95]],
        'èˆŒé‚Šï¼ˆè‚è†½ï¼‰å·¦': [[0.1,0.35],[0.25,0.35],[0.25,0.7],[0.15,0.7]],
        'èˆŒä¸­ï¼ˆè„¾èƒƒï¼‰': [[0.35,0.25],[0.65,0.25],[0.65,0.7],[0.35,0.7]],
        'èˆŒé‚Šï¼ˆè‚è†½ï¼‰å³': [[0.75,0.35],[0.9,0.35],[0.85,0.7],[0.75,0.7]],
        'èˆŒæ ¹ï¼ˆè…ï¼‰': [[0.25,0.0],[0.75,0.0],[0.75,0.25],[0.25,0.25]]
      };
      ctx.strokeStyle = 'red'; ctx.lineWidth = 2;
      ctx.font = '16px sans-serif'; ctx.fillStyle = '#000';
      Object.entries(zones).forEach(([name, rel]) => {
        ctx.beginPath();
        rel.forEach((pt,i) => {
          const x = Math.min(zx + zw * pt[0], video.videoWidth - 1);
          const y = Math.min(zy + zh * pt[1], video.videoHeight - 1);
          i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
        });
        ctx.closePath(); ctx.stroke();
        const cx = rel.reduce((s,p)=>s+Math.min(zx+zw*p[0], video.videoWidth - 1),0)/4;
        const cy = rel.reduce((s,p)=>s+Math.min(zy+zh*p[1], video.videoHeight - 1),0)/4;
        ctx.fillText(name, cx - ctx.measureText(name).width/2, cy + 5);
      });
    } else {
      // âš ï¸ ç„¡æ³•è¾¨è­˜èˆŒé ­æç¤º
      ctx.font = '20px sans-serif';
      ctx.fillStyle = 'red';
      ctx.fillText('âš ï¸ ç„¡æ³•è¾¨è­˜èˆŒé ­ï¼Œè«‹é‡æ–°æ‹æ”', 20, 50);
    }

    src.delete(); hsv.delete(); low.delete(); high.delete(); mask.delete(); M.delete(); contours.delete(); hier.delete();
    requestAnimationFrame(drawOverlay);
  }

  captureBtn.addEventListener('click', () => {
    const snap = document.createElement('canvas');
    snap.width = video.videoWidth; snap.height = video.videoHeight;
    const c = snap.getContext('2d'); c.drawImage(video,0,0); c.drawImage(canvas,0,0);
    snap.toBlob(b => { snapshotBlob = b; alert('ğŸ“¸ æ‹ç…§å®Œæˆï¼'); }, 'image/jpeg');
  });

  // ... uploadBtn, historyBtn ä¿æŒåŸæ¨£
};
</script>
