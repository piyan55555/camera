<script>
  const video = document.getElementById("camera");
  const canvas = document.getElementById("overlay");
  const captureBtn = document.getElementById("captureBtn");
  const uploadBtn = document.getElementById("uploadBtn");
  const historyBtn = document.getElementById("historyBtn");
  const patientInput = document.getElementById("patientId");
  const result = document.getElementById("result");
  let snapshotBlob = null;

  // å•Ÿå‹•ç›¸æ©Ÿ
  navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: "environment" } } })
    .then(stream => {
      video.srcObject = stream;
    })
    .catch(err => {
      alert("âŒ é¡é ­å•Ÿå‹•å¤±æ•—ï¼š" + err.message);
    });

  function onOpenCvReady() {
    console.log('OpenCV.js å·²è¼‰å…¥');
    requestAnimationFrame(drawOverlay);
  }

  // ä½¿ç”¨ OpenCV.js åµæ¸¬èˆŒé ­ä¸¦ç¹ªè£½è¼ªå»“èˆ‡äº”å€ï¼ˆç•¥ï¼Œä¿æŒåŸæ¨£ï¼‰

  // æ‹ç…§
  captureBtn.addEventListener("click", () => {
    const snap = document.createElement("canvas");
    snap.width = video.videoWidth; snap.height = video.videoHeight;
    const ctx = snap.getContext("2d");
    ctx.drawImage(video, 0, 0);
    ctx.drawImage(canvas, 0, 0);
    snap.toBlob(blob => {
      snapshotBlob = blob;
      alert("ğŸ“¸ æ‹ç…§å®Œæˆï¼Œè«‹è¼¸å…¥ç—…æ‚£ ID ä¸¦ä¸Šå‚³ï¼");
    }, "image/jpeg");
  });

  // ä¸Šå‚³åœ–ç‰‡
  uploadBtn.addEventListener("click", () => {
    const patientId = patientInput.value.trim();
    if (!snapshotBlob) return alert("è«‹å…ˆæ‹ç…§ï¼");
    if (!patientId) return alert("è«‹è¼¸å…¥ç—…æ‚£ ID");
    const formData = new FormData();
    formData.append("image", snapshotBlob);
    formData.append("patient_id", patientId);
    fetch("/upload", { method: "POST", body: formData })
      .then(res => res.json())
      .then(data => {
        const rgb = data["ä¸»è‰²RGB"];
        let html = `
          <p>âœ… ä¸Šå‚³æˆåŠŸï¼š<strong>${data.filename}</strong></p>
          <p>ğŸ” èˆŒè‹”ä¸»è‰²ï¼š<strong>${data["èˆŒè‹”ä¸»è‰²"]}</strong></p>
          <p>ğŸ§  ä¸­é†«æ¨è«–ï¼š${data["ä¸­é†«æ¨è«–"]}</p>
          <p>ğŸ¨ ä¸»è‰²é è¦½ï¼š
            <span style="display:inline-block;width:30px;height:30px;border-radius:5px;border:1px solid #333;background-color:rgb(${rgb[0]},${rgb[1]},${rgb[2]});"></span>
            <span style="margin-left:10px;font-size:0.9rem;color:#555;">RGB(${rgb[0]}, ${rgb[1]}, ${rgb[2]})</span>
          </p>
        `;
        if (data["äº”å€è¨ºæ–·"]) {
          html += `<h3>ğŸ—ºï¸ äº”å€è¨ºæ–·ï¼š</h3><table><tr><th>å€åŸŸ</th><th>é¡è‰²</th><th>è‰²éš</th><th>ä¸­é†«æ¨è«–</th></tr>`;
          for (const zone in data["äº”å€è¨ºæ–·"]) {
            const info = data["äº”å€è¨ºæ–·"][zone];
            const rgb = info["RGB"];
            const colorBox = `
              <div style="width: 40px; height: 20px; background-color: rgb(${rgb[0]}, ${rgb[1]}, ${rgb[2]}); border: 1px solid #000; border-radius: 4px; margin-bottom: 2px;"></div>
              <small>RGB(${rgb.join(", ")})</small>
            `;
            html += `<tr>
              <td>${zone}</td>
              <td>${info["é¡è‰²"]}</td>
              <td>${colorBox}</td>
              <td>${info["æ¨è«–"]}</td>
            </tr>`;
          }
          html += `</table>`;
        }
        result.innerHTML = html;
      })
      .catch(err => alert("âŒ ä¸Šå‚³å¤±æ•—ï¼š" + err.message));
  });

  // æŸ¥çœ‹æ­·å²ç…§ç‰‡
  historyBtn.addEventListener("click", () => {
    const patientId = patientInput.value.trim();
    if (!patientId) return alert("è«‹å…ˆè¼¸å…¥ç—…æ‚£ ID");
    window.location.href = `/history?patient=${patientId}`;
  });
</script>
