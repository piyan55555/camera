<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>舌苔五區分析系統</title>
  <style>
    body {
      font-family: sans-serif;
      line-height: 1.8;
    }
    #tongue-map {
      width: 300px;
      cursor: pointer;
      border: 2px solid #ccc;
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <h1>舌苔五區分析系統</h1>

  <form id="upload-form" enctype="multipart/form-data">
    <h2>互動前測題</h2>

    <h3>1. 你今天早上有刷舌苔嗎？</h3>
    <label><input type="radio" name="brushed" value="yes" required> 有</label>
    <label><input type="radio" name="brushed" value="no"> 沒有</label><br><br>

    <h3>2. 你覺得舌苔顏色偏向？</h3>
    <select name="self_observation">
      <option value="白">白</option>
      <option value="黃">黃</option>
      <option value="紅">紅</option>
      <option value="黑灰">黑灰</option>
      <option value="不確定">不確定</option>
    </select><br><br>

    <h3>3. 判斷題：哪個區域代表「腎」？</h3>
    <label><input type="radio" name="kidney_area" value="舌尖" required> 舌尖</label><br>
    <label><input type="radio" name="kidney_area" value="舌根"> 舌根</label><br>
    <label><input type="radio" name="kidney_area" value="舌邊"> 舌邊</label><br><br>

    <h3>4. 請點選你覺得舌頭異常的區域：</h3>
    <img id="tongue-map" src="/static/tongue_map.png" />
    <p id="selected-region">你點選的區域：<span id="selected-region-text">尚未選擇</span></p>
    <input type="hidden" name="selected_region" id="selected-region-input" /><br><br>

    <h3>5. 上傳你的舌頭照片：</h3>
    <input type="file" name="image" required /><br><br>

    <button type="submit">提交分析</button>
  </form>

  <hr>
  <h2>分析結果</h2>
  <div id="result"></div>

  <script>
    // 簡易分區點擊對應
    document.getElementById('tongue-map').addEventListener('click', function(e) {
      const rect = this.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      let region = "未知";
      if (y < 80 && x > 100 && x < 200) region = "心";
      else if (y >= 80 && y < 150 && x < 100) region = "肝";
      else if (y >= 80 && y < 150 && x > 200) region = "脾";
      else if (y < 80 && x < 100) region = "肺";
      else if (y > 200 && x > 100 && x < 200) region = "腎";

      document.getElementById('selected-region-text').textContent = region;
      document.getElementById('selected-region-input').value = region;
    });

    document.getElementById('upload-form').onsubmit = async function (e) {
      e.preventDefault();
      const formData = new FormData(this);
      const res = await fetch('/analyze', {
        method: 'POST',
        body: formData
      });
      const data = await res.json();

      const reply = data["使用者回覆"];
      const result = data["分析結果"];

      let html = `<h3>使用者回覆</h3>
      <p>是否刷舌苔：${reply.是否刷舌}</p>
      <p>自覺舌苔顏色：${reply.自覺顏色}</p>
      <p>你認為腎在：${reply.腎區域判斷}</p>
      <p>你點選異常區域：${reply.點選異常區}</p>`;

      html += `<hr><h3>舌苔五區分析結果</h3>`;
      for (let key in result) {
        html += `<h4>${key}</h4>`;
        html += `<ul>
          <li><strong>診斷：</strong>${result[key].診斷}</li>
          <li><strong>理論：</strong>${result[key].理論}</li>
          <li><strong>建議：</strong>${result[key].建議}</li>
        </ul>`;
      }
      document.getElementById('result').innerHTML = html;
    };
  </script>
</body>
</html>
