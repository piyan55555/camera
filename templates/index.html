<script>
  const video = document.getElementById("camera");
  const canvas = document.getElementById("overlay");
  const captureBtn = document.getElementById("captureBtn");
  const uploadBtn = document.getElementById("uploadBtn");
  const historyBtn = document.getElementById("historyBtn");
  const patientInput = document.getElementById("patientId");
  const result = document.getElementById("result");
  let snapshotBlob = null;

  // 啟動相機
  navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: "environment" } } })
    .then(stream => {
      video.srcObject = stream;
    })
    .catch(err => {
      alert("❌ 鏡頭啟動失敗：" + err.message);
    });

  function onOpenCvReady() {
    console.log('OpenCV.js 已載入');
    requestAnimationFrame(drawOverlay);
  }

  // 使用 OpenCV.js 偵測舌頭並繪製輪廓與五區（略，保持原樣）

  // 拍照
  captureBtn.addEventListener("click", () => {
    const snap = document.createElement("canvas");
    snap.width = video.videoWidth; snap.height = video.videoHeight;
    const ctx = snap.getContext("2d");
    ctx.drawImage(video, 0, 0);
    ctx.drawImage(canvas, 0, 0);
    snap.toBlob(blob => {
      snapshotBlob = blob;
      alert("📸 拍照完成，請輸入病患 ID 並上傳！");
    }, "image/jpeg");
  });

  // 上傳圖片
  uploadBtn.addEventListener("click", () => {
    const patientId = patientInput.value.trim();
    if (!snapshotBlob) return alert("請先拍照！");
    if (!patientId) return alert("請輸入病患 ID");
    const formData = new FormData();
    formData.append("image", snapshotBlob);
    formData.append("patient_id", patientId);
    fetch("/upload", { method: "POST", body: formData })
      .then(res => res.json())
      .then(data => {
        const rgb = data["主色RGB"];
        let html = `
          <p>✅ 上傳成功：<strong>${data.filename}</strong></p>
          <p>🔍 舌苔主色：<strong>${data["舌苔主色"]}</strong></p>
          <p>🧠 中醫推論：${data["中醫推論"]}</p>
          <p>🎨 主色預覽：
            <span style="display:inline-block;width:30px;height:30px;border-radius:5px;border:1px solid #333;background-color:rgb(${rgb[0]},${rgb[1]},${rgb[2]});"></span>
            <span style="margin-left:10px;font-size:0.9rem;color:#555;">RGB(${rgb[0]}, ${rgb[1]}, ${rgb[2]})</span>
          </p>
        `;
        if (data["五區診斷"]) {
          html += `<h3>🗺️ 五區診斷：</h3><table><tr><th>區域</th><th>顏色</th><th>色階</th><th>中醫推論</th></tr>`;
          for (const zone in data["五區診斷"]) {
            const info = data["五區診斷"][zone];
            const rgb = info["RGB"];
            const colorBox = `
              <div style="width: 40px; height: 20px; background-color: rgb(${rgb[0]}, ${rgb[1]}, ${rgb[2]}); border: 1px solid #000; border-radius: 4px; margin-bottom: 2px;"></div>
              <small>RGB(${rgb.join(", ")})</small>
            `;
            html += `<tr>
              <td>${zone}</td>
              <td>${info["顏色"]}</td>
              <td>${colorBox}</td>
              <td>${info["推論"]}</td>
            </tr>`;
          }
          html += `</table>`;
        }
        result.innerHTML = html;
      })
      .catch(err => alert("❌ 上傳失敗：" + err.message));
  });

  // 查看歷史照片
  historyBtn.addEventListener("click", () => {
    const patientId = patientInput.value.trim();
    if (!patientId) return alert("請先輸入病患 ID");
    window.location.href = `/history?patient=${patientId}`;
  });
</script>
